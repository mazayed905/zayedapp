<!doctype html>
<html lang="ar" dir="rtl" class="lang-ar theme-auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>برنامج قياس كتلة الجسم وخطة تخسيس 6 شهور — مشي فقط</title>
  <style>
    /* ====== Language visibility ====== */
    html.lang-ar .en{display:none !important;}
    html.lang-en .ar{display:none !important;}

    /* ====== Theme tokens (Auto uses prefers-color-scheme) ====== */
    :root{
      --bg:#0b1020; --card:#111a33; --text:#e9eefc; --muted:#a8b3d1;
      --pri:#22c55e; --sec:#60a5fa; --warn:#f59e0b; --bad:#ef4444;
      --bd:rgba(255,255,255,.12); --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --sans: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
        --pri:#16a34a; --sec:#2563eb; --warn:#b45309; --bad:#dc2626;
        --bd:rgba(15,23,42,.12); --shadow:0 10px 22px rgba(15,23,42,.10);
      }
    }
    /* Manual override */
    html.theme-dark{
      --bg:#0b1020; --card:#111a33; --text:#e9eefc; --muted:#a8b3d1;
      --pri:#22c55e; --sec:#60a5fa; --warn:#f59e0b; --bad:#ef4444;
      --bd:rgba(255,255,255,.12); --shadow:0 12px 30px rgba(0,0,0,.35);
    }
    html.theme-light{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --pri:#16a34a; --sec:#2563eb; --warn:#b45309; --bad:#dc2626;
      --bd:rgba(15,23,42,.12); --shadow:0 10px 22px rgba(15,23,42,.10);
    }

    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text); line-height:1.55;}
    .wrap{max-width:1120px; margin:0 auto; padding:14px 16px;}
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(0,0,0,.18);
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid var(--bd);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px}
    .sub{margin:2px 0 0; font-size:12.5px; color:var(--muted)}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--bd); background:var(--card); color:var(--text);
      padding:9px 12px; border-radius:999px; cursor:pointer; font-size:13px;
      box-shadow: var(--shadow);
    }
    .chip strong{font-family:var(--mono); font-size:12.5px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      border:1px solid var(--bd); background:var(--card); color:var(--text);
      padding:9px 12px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .tab[aria-selected="true"]{outline:2px solid rgba(96,165,250,.35); border-color:rgba(96,165,250,.65);}

    main{padding:16px 0 12px}
    .grid{display:grid; grid-template-columns:1.15fr .85fr; gap:14px; align-items:start;}
    @media (max-width:980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card); border:1px solid var(--bd); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .muted{color:var(--muted)}
    .small{font-size:12.5px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }
    label{display:block; margin:0 0 6px; font-size:12.5px; color:var(--muted)}
    input,select{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--bd);
      background:transparent; color:var(--text); outline:none; font-size:14px;
    }
    input:focus,select:focus{outline:2px solid rgba(96,165,250,.35); border-color:rgba(96,165,250,.65);}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--bd); background:transparent; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:13.5px;
    }
    button.primary{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.45);}
    button.danger{border-color:rgba(239,68,68,.55);}

    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:820px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:520px){ .kpis{grid-template-columns:1fr;} }
    .kpi{border:1px solid var(--bd); border-radius:14px; padding:10px; background:rgba(255,255,255,.02);}
    .kpi .v{font-family:var(--mono); font-size:18px}
    .kpi .t{font-size:12px; color:var(--muted)}

    .note{
      border-inline-start:4px solid var(--warn);
      padding:10px 12px; border-radius:12px;
      background:rgba(245,158,11,.10);
      font-size:13px;
    }
    .note.ok{border-inline-start-color:var(--pri); background:rgba(34,197,94,.10);}
    .note.bad{border-inline-start-color:var(--bad); background:rgba(239,68,68,.10);}

    .section{display:none}
    .section.active{display:block}

    table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--bd); border-radius:14px; overflow:hidden;}
    thead th{
      background:rgba(255,255,255,.04); color:var(--muted);
      font-size:12px; padding:10px; border-bottom:1px solid var(--bd);
      text-align:right; position:sticky; top:0;
    }
    tbody td{padding:10px; border-bottom:1px solid var(--bd); font-size:13px; vertical-align:top;}
    tbody tr:last-child td{border-bottom:none}
    [dir="ltr"] thead th{text-align:left;}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px; border:1px solid var(--bd);
      background:rgba(255,255,255,.03); font-size:12.5px;
    }
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{justify-content:flex-end}

    canvas{width:100%; height:240px; border:1px solid var(--bd); border-radius:14px; background:rgba(255,255,255,.02);}

    footer{border-top:1px solid var(--bd); margin-top:18px; padding:14px 0 26px;}
    .sig{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background:rgba(255,255,255,.03); border:1px solid var(--bd);
      border-radius:16px; padding:12px; box-shadow:var(--shadow);
    }
    .sig strong{font-size:13.5px}
    .sig .meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12.5px}
    .ltr{direction:ltr; unicode-bidi:plaintext}
    a{color:inherit; text-decoration:none; border-bottom:1px dashed rgba(100,116,139,.6)}
    a:hover{color:var(--sec)}

    @media print{
      header,.no-print{display:none !important}
      body{background:#fff; color:#000}
      .card{box-shadow:none}
      canvas{height:200px}
      a::after{content:" (" attr(href) ")"; font-size:10px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>
          <span class="ar">برنامج قياس كتلة الجسم + خطة تخسيس (6 شهور) — مشي فقط</span>
          <span class="en">Body Metrics + 6-Month Weight-Loss Plan — Walking Only</span>
        </h1>
        <div class="sub">
          <span class="ar">حسابات تقديرية للتثقيف والمتابعة — ليست بديلاً عن الاستشارة الطبية.</span>
          <span class="en">Educational estimates for tracking — not a substitute for medical advice.</span>
        </div>
      </div>

      <div class="controls no-print">
        <button class="chip" id="btnLang" title="Language">
          <span class="ar">اللغة</span><span class="en">Language</span>:
          <strong id="langVal">AR</strong>
        </button>
        <button class="chip" id="btnTheme" title="Theme">
          <span class="ar">المظهر</span><span class="en">Theme</span>:
          <strong id="themeVal">Auto</strong>
        </button>
      </div>
    </div>

    <nav class="tabs no-print" aria-label="tabs">
      <button class="tab" data-tab="calc" aria-selected="true"><span class="ar">الحاسبة</span><span class="en">Calculator</span></button>
      <button class="tab" data-tab="plan" aria-selected="false"><span class="ar">خطة 6 شهور</span><span class="en">6-Month Plan</span></button>
      <button class="tab" data-tab="track" aria-selected="false"><span class="ar">المتابعة</span><span class="en">Tracking</span></button>
      <button class="tab" data-tab="export" aria-selected="false"><span class="ar">الطباعة والتصدير</span><span class="en">Print & Export</span></button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- ===== Calculator ===== -->
  <section id="calc" class="section active">
    <div class="grid">
      <div class="card">
        <h2><span class="ar">البيانات الأساسية</span><span class="en">Basic data</span></h2>

        <div class="row">
          <div>
            <label for="sex"><span class="ar">الجنس</span><span class="en">Sex</span></label>
            <select id="sex">
              <option value="male"><span class="ar">ذكر</span><span class="en">Male</span></option>
              <option value="female"><span class="ar">أنثى</span><span class="en">Female</span></option>
            </select>
          </div>
          <div>
            <label for="age"><span class="ar">العمر (سنة)</span><span class="en">Age (years)</span></label>
            <input id="age" type="number" inputmode="numeric" min="10" max="90" value="30" />
          </div>
          <div>
            <label for="height"><span class="ar">الطول (سم)</span><span class="en">Height (cm)</span></label>
            <input id="height" type="number" inputmode="decimal" min="120" max="230" value="170" />
          </div>
          <div>
            <label for="weight"><span class="ar">الوزن الحالي (كجم)</span><span class="en">Current weight (kg)</span></label>
            <input id="weight" type="number" inputmode="decimal" min="30" max="250" value="85" />
          </div>
          <div>
            <label for="goal"><span class="ar">الوزن المستهدف بعد 6 شهور (كجم)</span><span class="en">Goal weight after 6 months (kg)</span></label>
            <input id="goal" type="number" inputmode="decimal" min="30" max="250" value="75" />
          </div>
          <div>
            <label for="activity"><span class="ar">مستوى النشاط اليومي</span><span class="en">Daily activity level</span></label>
            <select id="activity">
              <option value="1.2"><span class="ar">قليل جدًا (مكتبي)</span><span class="en">Very low (desk)</span></option>
              <option value="1.375"><span class="ar">خفيف</span><span class="en">Low</span></option>
              <option value="1.55" selected><span class="ar">متوسط (مشي منتظم)</span><span class="en">Moderate (walking)</span></option>
              <option value="1.725"><span class="ar">عالٍ</span><span class="en">High</span></option>
              <option value="1.9"><span class="ar">عالٍ جدًا</span><span class="en">Very high</span></option>
            </select>
          </div>
        </div>

        <h2 style="margin-top:14px"><span class="ar">قياسات الجسم (اختيارية)</span><span class="en">Body measurements (optional)</span></h2>
        <p class="muted small" style="margin-top:-6px">
          <span class="ar">لنسبة الدهون التقديرية (Navy): الخصر + الرقبة (وللإناث: الخصر + الورك + الرقبة).</span>
          <span class="en">For Navy body-fat estimate: waist + neck (women: waist + hip + neck).</span>
        </p>

        <div class="row">
          <div>
            <label for="waist"><span class="ar">محيط الخصر (سم)</span><span class="en">Waist (cm)</span></label>
            <input id="waist" type="number" inputmode="decimal" min="40" max="200" value="95" />
          </div>
          <div>
            <label for="neck"><span class="ar">محيط الرقبة (سم)</span><span class="en">Neck (cm)</span></label>
            <input id="neck" type="number" inputmode="decimal" min="20" max="80" value="38" />
          </div>
          <div>
            <label for="hip"><span class="ar">محيط الورك (سم) — للإناث</span><span class="en">Hip (cm) — women</span></label>
            <input id="hip" type="number" inputmode="decimal" min="50" max="220" value="105" />
          </div>
          <div>
            <label for="steps"><span class="ar">متوسط خطواتك اليومية الآن</span><span class="en">Current daily steps</span></label>
            <input id="steps" type="number" inputmode="numeric" min="0" max="40000" value="5000" />
          </div>
        </div>

        <div class="btns no-print">
          <button class="primary" id="btnCalc"><span class="ar">احسب وولّد الخطة</span><span class="en">Calculate & generate plan</span></button>
          <button id="btnSave"><span class="ar">حفظ الإعدادات</span><span class="en">Save</span></button>
          <button class="danger" id="btnReset"><span class="ar">مسح كل البيانات</span><span class="en">Reset</span></button>
        </div>

        <div class="note" style="margin-top:12px">
          <span class="ar">⚠️ في حال أمراض مزمنة/حمل/أدوية تؤثر على الوزن: راجع مختصًا قبل أي عجز كبير بالسعرات أو زيادة مفاجئة بالنشاط.</span>
          <span class="en">⚠️ If you have chronic conditions/pregnancy/weight-affecting meds: consult a professional before large deficits or sudden activity increases.</span>
        </div>
      </div>

      <div class="card">
        <h2><span class="ar">النتائج</span><span class="en">Results</span></h2>

        <div class="kpis">
          <div class="kpi"><div class="v" id="kBMI">—</div><div class="t"><span class="ar">BMI</span><span class="en">BMI</span></div></div>
          <div class="kpi"><div class="v" id="kBMICat">—</div><div class="t"><span class="ar">تصنيف BMI</span><span class="en">BMI category</span></div></div>
          <div class="kpi"><div class="v" id="kBF">—</div><div class="t"><span class="ar">دهون % (تقديري)</span><span class="en">Body fat % (est.)</span></div></div>

          <div class="kpi"><div class="v" id="kBMR">—</div><div class="t"><span class="ar">BMR (سعر/يوم)</span><span class="en">BMR (kcal/day)</span></div></div>
          <div class="kpi"><div class="v" id="kTDEE">—</div><div class="t"><span class="ar">TDEE (سعر/يوم)</span><span class="en">TDEE (kcal/day)</span></div></div>
          <div class="kpi"><div class="v" id="kCal">—</div><div class="t"><span class="ar">سعرات للتخسيس</span><span class="en">Cut calories</span></div></div>

          <div class="kpi"><div class="v" id="kWeekly">—</div><div class="t"><span class="ar">نزول/أسبوع</span><span class="en">Loss/week</span></div></div>
          <div class="kpi"><div class="v" id="kWHtR">—</div><div class="t"><span class="ar">WHtR</span><span class="en">WHtR</span></div></div>
          <div class="kpi"><div class="v" id="kHealthy">—</div><div class="t"><span class="ar">وزن صحي (تقريبي)</span><span class="en">Healthy range</span></div></div>
        </div>

        <div id="alerts" style="margin-top:12px; display:grid; gap:10px"></div>

        <div class="note ok" style="margin-top:12px">
          <span class="ar">✅ (مشي فقط) الأفضل: ثبات يومي + زيادة تدريجية + سرعة مناسبة بحيث تستطيع التحدث بصعوبة بسيطة.</span>
          <span class="en">✅ (Walking only) Best: daily consistency + gradual progression + brisk pace where talking is slightly difficult.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Plan ===== -->
  <section id="plan" class="section">
    <div class="card">
      <div class="flex right no-print">
        <span class="pill" id="planSummary">—</span>
        <span class="pill"><span class="ar">نوع البرنامج: مشي فقط</span><span class="en">Program: Walking only</span></span>
        <button class="primary" id="btnRegen"><span class="ar">إعادة توليد الخطة</span><span class="en">Regenerate</span></button>
      </div>

      <h2><span class="ar">الخطة التفصيلية (26 أسبوعًا) — مشي فقط</span><span class="en">Detailed plan (26 weeks) — Walking only</span></h2>
      <p class="muted small" style="margin-top:-6px">
        <span class="ar">إذا شعرت بإجهاد/آلام مفصلية: ثبّت أسبوعًا أو خفّض زمن المشي 20% ثم أكمل.</span>
        <span class="en">If you feel joint pain/fatigue: hold a week or reduce walking time by 20%, then continue.</span>
      </p>

      <h3 style="margin:14px 0 8px; font-size:14px"><span class="ar">الجدول الأسبوعي</span><span class="en">Weekly table</span></h3>
      <div style="max-height:520px; overflow:auto; border-radius:14px">
        <table id="planTable">
          <thead>
            <tr>
              <th><span class="ar">الأسبوع</span><span class="en">Week</span></th>
              <th><span class="ar">الوزن المستهدف</span><span class="en">Target weight</span></th>
              <th><span class="ar">السعرات/يوم</span><span class="en">Calories/day</span></th>
              <th><span class="ar">بروتين/يوم</span><span class="en">Protein/day</span></th>
              <th><span class="ar">المشي/أسبوع</span><span class="en">Walk/week</span></th>
              <th><span class="ar">دقائق/يوم</span><span class="en">Min/day</span></th>
              <th><span class="ar">خطوات/يوم</span><span class="en">Steps/day</span></th>
              <th><span class="ar">ملاحظة</span><span class="en">Note</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note" style="margin-top:12px">
        <span class="ar">⚠️ إذا نزل وزنك أسرع من ~1% أسبوعيًا لعدة أسابيع أو ظهرت دوخة/إرهاق شديد: ارفع السعرات قليلًا أو قلل زمن المشي وراجع مختصًا.</span>
        <span class="en">⚠️ If you lose faster than ~1%/week for several weeks or feel severe dizziness/fatigue: slightly increase calories or reduce walking time and consult a professional.</span>
      </div>
    </div>
  </section>

  <!-- ===== Tracking ===== -->
  <section id="track" class="section">
    <div class="grid">
      <div class="card">
        <h2><span class="ar">سجل المتابعة الأسبوعي</span><span class="en">Weekly tracking log</span></h2>
        <p class="muted small" style="margin-top:-6px">
          <span class="ar">القياس مرة أسبوعيًا. يتم الحفظ على جهازك (LocalStorage).</span>
          <span class="en">Log once per week. Saved on your device (LocalStorage).</span>
        </p>

        <div class="row">
          <div>
            <label for="logWeek"><span class="ar">الأسبوع (1–26)</span><span class="en">Week (1–26)</span></label>
            <input id="logWeek" type="number" inputmode="numeric" min="1" max="26" value="1" />
          </div>
          <div>
            <label for="logWeight"><span class="ar">الوزن الفعلي (كجم)</span><span class="en">Actual weight (kg)</span></label>
            <input id="logWeight" type="number" inputmode="decimal" min="30" max="250" />
          </div>
          <div>
            <label for="logWaist"><span class="ar">الخصر (سم)</span><span class="en">Waist (cm)</span></label>
            <input id="logWaist" type="number" inputmode="decimal" min="40" max="200" />
          </div>
          <div>
            <label for="logNotes"><span class="ar">ملاحظات</span><span class="en">Notes</span></label>
            <input id="logNotes" type="text" placeholder="..." />
          </div>
        </div>

        <div class="btns no-print">
          <button class="primary" id="btnAddLog"><span class="ar">إضافة/تحديث</span><span class="en">Add/update</span></button>
          <button id="btnNext"><span class="ar">الأسبوع التالي</span><span class="en">Next week</span></button>
          <button class="danger" id="btnClearLogs"><span class="ar">مسح السجل فقط</span><span class="en">Clear logs</span></button>
        </div>

        <h3 style="margin:14px 0 8px; font-size:14px"><span class="ar">السجل</span><span class="en">Logs</span></h3>
        <div style="max-height:420px; overflow:auto; border-radius:14px">
          <table id="logTable">
            <thead>
              <tr>
                <th><span class="ar">الأسبوع</span><span class="en">Week</span></th>
                <th><span class="ar">الوزن الفعلي</span><span class="en">Actual</span></th>
                <th><span class="ar">المستهدف</span><span class="en">Target</span></th>
                <th><span class="ar">الخصر</span><span class="en">Waist</span></th>
                <th><span class="ar">فرق</span><span class="en">Diff</span></th>
                <th><span class="ar">ملاحظات</span><span class="en">Notes</span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="note ok" style="margin-top:12px">
          <span class="ar">✅ أفضل مؤشر: متوسط الوزن أسبوعيًا + قياس الخصر.</span>
          <span class="en">✅ Best indicators: weekly average weight + waist.</span>
        </div>
      </div>

      <div class="card">
        <h2><span class="ar">الرسم البياني</span><span class="en">Chart</span></h2>
        <canvas id="chart" width="900" height="300"></canvas>
        <div class="flex" style="margin-top:10px">
          <span class="pill" id="legend">—</span>
          <span class="pill" id="status">—</span>
        </div>
        <div class="note" style="margin-top:12px">
          <span class="ar">ℹ️ الأزرق = المستهدف، الأخضر = الوزن الفعلي المُدخل.</span>
          <span class="en">ℹ️ Blue = target, Green = logged actual.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Export ===== -->
  <section id="export" class="section">
    <div class="card">
      <h2><span class="ar">الطباعة والتصدير</span><span class="en">Print & export</span></h2>
      <div class="btns no-print">
        <button class="primary" id="btnPrint"><span class="ar">طباعة (PDF)</span><span class="en">Print (PDF)</span></button>
        <button id="btnExportPlan"><span class="ar">تصدير الخطة CSV</span><span class="en">Export plan CSV</span></button>
        <button id="btnExportLogs"><span class="ar">تصدير السجل CSV</span><span class="en">Export logs CSV</span></button>
      </div>

      <h3 style="margin:14px 0 8px; font-size:14px"><span class="ar">ملاحظة سلامة</span><span class="en">Safety note</span></h3>
      <ul class="muted small" style="margin:0; padding:0 18px 0 0">
        <li><span class="ar">النزول الآمن غالبًا 0.25–1.0 كجم/أسبوع حسب الظروف.</span><span class="en">Safe loss is usually ~0.25–1.0 kg/week depending on context.</span></li>
        <li><span class="ar">تجنّب سعرات منخفضة جدًا لفترة طويلة دون إشراف.</span><span class="en">Avoid very low calories for long periods without supervision.</span></li>
        <li><span class="ar">ألم صدري/دوخة شديدة/إغماء: أوقف النشاط واطلب تقييمًا طبيًا.</span><span class="en">Chest pain/severe dizziness/fainting: stop and seek medical evaluation.</span></li>
      </ul>
    </div>
  </section>
</main>

<footer>
  <div class="wrap">
    <div class="sig" aria-label="signature">
      <strong>
        <span class="ar">البرنامج من تصميم وإعداد الدكتور محمد عبد الحميد زايد</span>
        <span class="en">Designed & Prepared by Dr. Mohamed Abdelhamid Zayed</span>
      </strong>
      <div class="meta">
        <span class="pill"><span class="ar">هاتف</span><span class="en">Phone</span>: <span class="ltr"><a href="tel:+966580673992">٠٥٨٠٦٧٣٩٩٢</a></span></span>
        <span class="pill"><span class="ar">إيميل</span><span class="en">Email</span>: <span class="ltr"><a href="mailto:mazayed@kfu.edu.sa">mazayed@kfu.edu.sa</a></span></span>
      </div>
    </div>
  </div>
</footer>

<script>
  /* =========================
     Storage
  ========================= */
  const STORE = "WL_WALKONLY_6M_V2";
  const $ = (id)=>document.getElementById(id);
  const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
  const round = (x,d=0)=>{ const p=10**d; return Math.round((x+Number.EPSILON)*p)/p; };
  const loc = ()=> document.documentElement.classList.contains("lang-ar") ? "ar-SA" : "en-US";
  const fmt = (x, d=0)=> Number.isFinite(x) ? round(x,d).toLocaleString(loc()) : "—";
  const fmtInt = (x)=> Number.isFinite(x) ? Math.round(x).toLocaleString(loc()) : "—";

  const TXT = {
    ar:{
      bmi:["نحافة","طبيعي","زيادة وزن","سمنة (1)","سمنة (2)","سمنة (3)"],
      whtr:["جيدة","مرتفعة","مرتفعة جدًا"],
      months:[
        "شهر 1: تأسيس عادة المشي + ثبات",
        "شهر 2: زيادة الزمن والوتيرة",
        "شهر 3: إدخال فترات مشي سريع",
        "شهر 4: رفع الخطوات تدريجيًا",
        "شهر 5: صقل الالتزام + تعافٍ",
        "شهر 6: تثبيت النتائج والاستمرار"
      ],
      walkNotes:[
        "مشي مريح + زيادة تدريجية",
        "مشي سريع خفيف 5–10 دقائق ضمن الجلسة",
        "2 أيام: 6×(1د سريع/1د عادي)",
        "3 أيام: فترات سريعة قصيرة",
        "أضف ميلان بسيط/سرعة أعلى حسب القدرة",
        "1 يوم طويل (60د كل أسبوعين) إذا مناسب"
      ],
      msgSaved:"تم الحفظ ✅",
      msgNeedPlan:"ولّد الخطة أولًا من الحاسبة.",
      msgWeekRange:"رقم الأسبوع يجب أن يكون بين 1 و 26.",
      msgEnterWeight:"أدخل الوزن الفعلي.",
      msgUpdated:"تم تحديث السجل ✅",
      msgConfirmAll:"سيتم مسح كل البيانات (الخطة + السجل). هل تريد المتابعة؟",
      msgConfirmLogs:"سيتم مسح سجل المتابعة فقط. هل تريد المتابعة؟",
      themeAuto:"تلقائي", themeLight:"نهاري", themeDark:"ليلي",
      legend:"الأزرق: المستهدف — الأخضر: الفعلي",
      ahead:(x,w)=>`متقدّم عن الهدف بـ ${x} كجم (أسبوع ${w})`,
      behind:(x,w)=>`متأخر عن الهدف بـ ${x} كجم (أسبوع ${w})`
    },
    en:{
      bmi:["Underweight","Normal","Overweight","Obesity (I)","Obesity (II)","Obesity (III)"],
      whtr:["Good","High","Very high"],
      months:[
        "Month 1: build the habit + consistency",
        "Month 2: increase time & pace",
        "Month 3: add brisk intervals",
        "Month 4: raise steps gradually",
        "Month 5: refine adherence + recovery",
        "Month 6: stabilize & continue"
      ],
      walkNotes:[
        "Easy walking + gradual build",
        "Light brisk 5–10 min inside the session",
        "2 days: 6×(1 min brisk/1 min easy)",
        "3 days: short brisk intervals",
        "Add slight incline/higher pace as tolerated",
        "1 long day (60 min every two weeks) if suitable"
      ],
      msgSaved:"Saved ✅",
      msgNeedPlan:"Generate the plan first from Calculator.",
      msgWeekRange:"Week must be between 1 and 26.",
      msgEnterWeight:"Enter actual weight.",
      msgUpdated:"Log updated ✅",
      msgConfirmAll:"This will clear ALL data (plan + logs). Continue?",
      msgConfirmLogs:"This will clear logs only. Continue?",
      themeAuto:"Auto", themeLight:"Day", themeDark:"Night",
      legend:"Blue: target — Green: actual",
      ahead:(x,w)=>`Ahead of target by ${x} kg (Week ${w})`,
      behind:(x,w)=>`Behind target by ${x} kg (Week ${w})`
    }
  };
  const T = ()=> document.documentElement.classList.contains("lang-ar") ? TXT.ar : TXT.en;

  let state = {
    settings:{ lang:"ar", theme:"auto" },
    inputs:{ sex:"male", age:30, height:170, weight:85, goal:75, activity:1.55, waist:95, neck:38, hip:105, steps:5000 },
    plan:null,
    logs:{}
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORE);
      if(!raw) return;
      const s = JSON.parse(raw);
      state = {
        ...state,
        ...s,
        settings:{...state.settings, ...(s.settings||{})},
        inputs:{...state.inputs, ...(s.inputs||{})},
        logs:s.logs||{}
      };
    }catch(e){}
  }
  function save(){ localStorage.setItem(STORE, JSON.stringify(state)); }

  /* =========================
     Theme & Language
  ========================= */
  function applyLang(){
    const html = document.documentElement;
    html.classList.toggle("lang-ar", state.settings.lang==="ar");
    html.classList.toggle("lang-en", state.settings.lang==="en");
    html.setAttribute("dir", state.settings.lang==="ar" ? "rtl" : "ltr");
    html.setAttribute("lang", state.settings.lang==="ar" ? "ar" : "en");
    $("langVal").textContent = state.settings.lang==="ar" ? "AR" : "EN";
  }
  function applyTheme(){
    const html = document.documentElement;
    html.classList.remove("theme-auto","theme-light","theme-dark");
    html.classList.add(state.settings.theme==="auto" ? "theme-auto" : (state.settings.theme==="light" ? "theme-light" : "theme-dark"));
    $("themeVal").textContent = state.settings.theme==="auto" ? T().themeAuto : (state.settings.theme==="light" ? T().themeLight : T().themeDark);
  }
  function cycleLang(){
    state.settings.lang = (state.settings.lang==="ar") ? "en" : "ar";
    save(); applyLang(); // also re-render dynamic
    renderAll();
  }
  function cycleTheme(){
    const order=["auto","light","dark"];
    const i=order.indexOf(state.settings.theme);
    state.settings.theme=order[(i+1)%order.length];
    save(); applyTheme();
  }

  /* =========================
     Math helpers
  ========================= */
  function toInches(cm){ return cm/2.54; }
  function log10(x){ return Math.log(x)/Math.log(10); }

  function bmiCat(bmi){
    if(!Number.isFinite(bmi)) return "—";
    if(bmi<18.5) return T().bmi[0];
    if(bmi<25) return T().bmi[1];
    if(bmi<30) return T().bmi[2];
    if(bmi<35) return T().bmi[3];
    if(bmi<40) return T().bmi[4];
    return T().bmi[5];
  }
  function whtrCat(r){
    if(!Number.isFinite(r)) return "—";
    if(r<0.5) return T().whtr[0];
    if(r<0.6) return T().whtr[1];
    return T().whtr[2];
  }

  function navyBF(sex, hCm, waistCm, neckCm, hipCm){
    if(![hCm,waistCm,neckCm].every(v=>Number.isFinite(v)&&v>0)) return NaN;
    const h=toInches(hCm), w=toInches(waistCm), n=toInches(neckCm);
    if(sex==="male"){
      const x=w-n; if(x<=0) return NaN;
      return 495/(1.0324 - 0.19077*log10(x) + 0.15456*log10(h)) - 450;
    }else{
      if(!(Number.isFinite(hipCm)&&hipCm>0)) return NaN;
      const hip=toInches(hipCm);
      const x=w+hip-n; if(x<=0) return NaN;
      return 495/(1.29579 - 0.35004*log10(x) + 0.22100*log10(h)) - 450;
    }
  }
  function bmrMifflin(sex, wKg, hCm, age){
    if(![wKg,hCm,age].every(v=>Number.isFinite(v)&&v>0)) return NaN;
    const base = 10*wKg + 6.25*hCm - 5*age;
    return sex==="male" ? base+5 : base-161;
  }
  function healthyRange(hCm){
    const h=hCm/100; if(!(Number.isFinite(h)&&h>0)) return null;
    return {min:18.5*h*h, max:24.9*h*h};
  }
  function proteinG(wKg, goalKg){
    const basis = (Number.isFinite(goalKg)&&goalKg>0) ? goalKg : wKg;
    return clamp(basis*1.8, 90, 220);
  }

  /* =========================
     Plan generator (26 weeks) - walking only
  ========================= */
  function walkPrescription(wk){
    // days, minutes + note index
    if(wk<=4)  return {days:4, mins:25, ni:0};
    if(wk<=8)  return {days:5, mins:30, ni:1};
    if(wk<=12) return {days:5, mins:35, ni:2};
    if(wk<=16) return {days:6, mins:40, ni:3};
    if(wk<=20) return {days:6, mins:45, ni:4};
    return {days:6, mins:50, ni:5};
  }
  function monthNote(wk){
    const m = Math.min(6, Math.max(1, Math.ceil(wk/4.33)));
    return T().months[m-1];
  }
  function sumLoss(weeks, baseWkLoss, upto, delta){
    let s=0;
    for(let w=1; w<=upto; w++){
      const taper = 1 - 0.15*(w-1)/(weeks-1);
      s += baseWkLoss*taper;
    }
    return Math.min(s, delta);
  }

  function generatePlan(inp){
    const weeks=26;
    const w0=inp.weight, goal=inp.goal;
    const delta=w0-goal;

    const bmr=bmrMifflin(inp.sex,w0,inp.height,inp.age);
    const tdee=bmr*inp.activity;

    let mode="loss";
    if(!Number.isFinite(delta) || delta<=0.2) mode="maintain";

    const maxByPercent = w0*0.01;
    let wkLoss = mode==="loss" ? (delta/weeks) : 0;
    wkLoss = clamp(wkLoss, 0.25, Math.min(1.0, maxByPercent));

    const kcalPerKg=7700;
    let dailyDef = mode==="loss" ? (wkLoss*kcalPerKg/7) : 0;
    let calTarget = tdee - dailyDef;

    const minCal = inp.sex==="male" ? 1500 : 1200;
    let adjusted=false;
    if(mode==="loss" && calTarget<minCal){
      calTarget=minCal;
      dailyDef=Math.max(0, tdee-calTarget);
      wkLoss=(dailyDef*7)/kcalPerKg;
      adjusted=true;
    }

    const baseSteps = Number.isFinite(inp.steps) ? inp.steps : 5000;
    const stepsStart = clamp(baseSteps, 2000, 12000);
    const stepsEnd   = clamp(Math.round(stepsStart+4000), 6500, 15000);

    const pG = Math.round(proteinG(w0, goal));

    const rows=[];
    for(let wk=1; wk<=weeks; wk++){
      const targetW = (mode==="loss") ? (w0 - sumLoss(weeks, wkLoss, wk, delta)) : w0;
      const stepsDay = Math.round(stepsStart + (stepsEnd-stepsStart)*(wk-1)/(weeks-1));
      const wp = walkPrescription(wk);
      rows.push({
        week:wk,
        targetW:round(targetW,1),
        calories:Math.round(calTarget),
        protein:pG,
        days:wp.days,
        mins:wp.mins,
        steps:stepsDay,
        note: `${monthNote(wk)} — ${T().walkNotes[wp.ni]}`
      });
    }
    return {mode, bmr:Math.round(bmr), tdee:Math.round(tdee), calories:Math.round(calTarget), wkLoss:round(wkLoss,2), protein:pG, adjusted, rows};
  }

  /* =========================
     Rendering
  ========================= */
  function readInputs(){
    state.inputs = {
      sex:$("sex").value,
      age:parseFloat($("age").value),
      height:parseFloat($("height").value),
      weight:parseFloat($("weight").value),
      goal:parseFloat($("goal").value),
      activity:parseFloat($("activity").value),
      waist:parseFloat($("waist").value),
      neck:parseFloat($("neck").value),
      hip:parseFloat($("hip").value),
      steps:parseFloat($("steps").value)
    };
    return state.inputs;
  }
  function bindInputs(){
    const i=state.inputs;
    $("sex").value=i.sex;
    $("age").value=i.age;
    $("height").value=i.height;
    $("weight").value=i.weight;
    $("goal").value=i.goal;
    $("activity").value=String(i.activity);
    $("waist").value=Number.isFinite(i.waist)?i.waist:"";
    $("neck").value=Number.isFinite(i.neck)?i.neck:"";
    $("hip").value=Number.isFinite(i.hip)?i.hip:"";
    $("steps").value=Number.isFinite(i.steps)?i.steps:"";
  }

  function setAlerts(list){
    const box=$("alerts");
    box.innerHTML="";
    list.forEach(a=>{
      const div=document.createElement("div");
      div.className="note "+(a.type||"");
      div.textContent=a.text;
      box.appendChild(div);
    });
  }

  function renderResults(){
    const i=state.inputs;
    const h=i.height/100;
    const bmi = i.weight/(h*h);
    const cat = bmiCat(bmi);

    const bmr=bmrMifflin(i.sex,i.weight,i.height,i.age);
    const tdee=bmr*i.activity;

    const bf=navyBF(i.sex,i.height,i.waist,i.neck,i.hip);
    const whtr = (Number.isFinite(i.waist)&&Number.isFinite(i.height)&&i.height>0) ? (i.waist/i.height) : NaN;
    const hr=healthyRange(i.height);

    $("kBMI").textContent = Number.isFinite(bmi)?fmt(bmi,2):"—";
    $("kBMICat").textContent = cat;
    $("kBF").textContent = Number.isFinite(bf)?(fmt(bf,1)+"%"):"—";
    $("kBMR").textContent = Number.isFinite(bmr)?fmtInt(bmr):"—";
    $("kTDEE").textContent = Number.isFinite(tdee)?fmtInt(tdee):"—";
    $("kWHtR").textContent = Number.isFinite(whtr)?(fmt(whtr,2)+" ("+whtrCat(whtr)+")"):"—";
    $("kHealthy").textContent = hr ? (fmt(hr.min,1)+" – "+fmt(hr.max,1)+" kg") : "—";

    if(state.plan){
      $("kCal").textContent = fmtInt(state.plan.calories);
      $("kWeekly").textContent = (state.plan.mode==="loss") ? (fmt(state.plan.wkLoss,2)+" kg") : (document.documentElement.classList.contains("lang-ar") ? "تثبيت" : "Maintain");
    }else{
      $("kCal").textContent="—";
      $("kWeekly").textContent="—";
    }

    const alerts=[];
    const delta=i.weight-i.goal;
    if(!Number.isFinite(delta) || delta<-0.2){
      alerts.push({type:"ok", text: document.documentElement.classList.contains("lang-ar")
        ? "أدخلت وزنًا مستهدفًا أعلى من الحالي — سيتم توليد خطة تثبيت/تحسين لياقة (مشي فقط)."
        : "Goal weight is higher than current — a maintenance/fitness plan will be generated (walking only)."
      });
    }else if(delta<=0.2){
      alerts.push({type:"ok", text: document.documentElement.classList.contains("lang-ar")
        ? "الفرق بين الوزن الحالي والمستهدف صغير — الخطة ستكون أقرب للتثبيت وتحسين العادات."
        : "Goal is very close — plan will focus on maintenance & habits."
      });
    }else{
      alerts.push({type:"ok", text: document.documentElement.classList.contains("lang-ar")
        ? `هدفك: نزول ${fmt(delta,1)} كجم خلال 6 شهور (مشي فقط).`
        : `Goal: lose ${fmt(delta,1)} kg in 6 months (walking only).`
      });
    }
    if(Number.isFinite(whtr) && whtr>=0.6){
      alerts.push({type:"bad", text: document.documentElement.classList.contains("lang-ar")
        ? "نسبة الخصر/الطول مرتفعة جدًا — ركّز على المشي اليومي + ضبط السعرات."
        : "WHtR is very high — focus on daily walking + calorie control."
      });
    }else if(Number.isFinite(whtr) && whtr>=0.5){
      alerts.push({type:"", text: document.documentElement.classList.contains("lang-ar")
        ? "نسبة الخصر/الطول مرتفعة — غالبًا يتحسن الخصر أولًا مع الاستمرارية."
        : "WHtR is elevated — waist often improves first with consistency."
      });
    }
    if(!Number.isFinite(bf)){
      alerts.push({type:"", text: document.documentElement.classList.contains("lang-ar")
        ? "لم يتم حساب نسبة الدهون: أدخل الخصر والرقبة (وللإناث أيضًا الورك)."
        : "Body-fat estimate not computed: enter waist & neck (women: also hip)."
      });
    }
    setAlerts(alerts);
  }

  function renderPlan(){
    const tb=$("planTable").querySelector("tbody");
    tb.innerHTML="";
    if(!state.plan){ $("planSummary").textContent="—"; return; }

    const p=state.plan;
    $("planSummary").textContent = document.documentElement.classList.contains("lang-ar")
      ? `سعرات: ${fmtInt(p.calories)}/يوم — بروتين: ~${fmtInt(p.protein)} جم — نزول: ${fmt(p.wkLoss,2)} كجم/أسبوع`
      : `Calories: ${fmtInt(p.calories)}/day — Protein: ~${fmtInt(p.protein)} g — Loss: ${fmt(p.wkLoss,2)} kg/week`;

    p.rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><span class="pill">#${r.week}</span></td>
        <td style="font-family:var(--mono)">${fmt(r.targetW,1)}</td>
        <td style="font-family:var(--mono)">${fmtInt(r.calories)}</td>
        <td style="font-family:var(--mono)">${fmtInt(r.protein)}</td>
        <td>${r.days} ${document.documentElement.classList.contains("lang-ar")?"أيام":"days"}</td>
        <td>${r.mins} ${document.documentElement.classList.contains("lang-ar")?"دقيقة":"min"}</td>
        <td style="font-family:var(--mono)">${fmtInt(r.steps)}</td>
        <td class="muted small">${escapeHtml(r.note)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function renderLogs(){
    const tb=$("logTable").querySelector("tbody");
    tb.innerHTML="";
    for(let wk=1; wk<=26; wk++){
      const log=state.logs[String(wk)];
      const target=state.plan?.rows?.[wk-1]?.targetW;
      const w=log?.weight;
      const diff=(Number.isFinite(w)&&Number.isFinite(target)) ? round(w-target,1) : NaN;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><span class="pill">#${wk}</span></td>
        <td style="font-family:var(--mono)">${Number.isFinite(w)?fmt(w,1):"—"}</td>
        <td style="font-family:var(--mono)">${Number.isFinite(target)?fmt(target,1):"—"}</td>
        <td style="font-family:var(--mono)">${Number.isFinite(log?.waist)?fmt(log.waist,1):"—"}</td>
        <td>${Number.isFinite(diff)?(diff>0?("+"+fmt(diff,1)):fmt(diff,1)):"—"}</td>
        <td class="muted small">${log?.notes?escapeHtml(log.notes):"—"}</td>
      `;
      tb.appendChild(tr);
    }
  }

  /* ===== Simple canvas chart ===== */
  function drawChart(){
    const c=$("chart"), ctx=c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    if(!state.plan){
      ctx.font="16px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText(document.documentElement.classList.contains("lang-ar")?"ولّد الخطة أولًا من الحاسبة.":"Generate plan first from Calculator.", 20, 40);
      $("legend").textContent="—";
      $("status").textContent="—";
      return;
    }

    const target=state.plan.rows.map(r=>r.targetW);
    const actual=[];
    for(let wk=1; wk<=26; wk++){
      const v=state.logs[String(wk)]?.weight;
      actual.push(Number.isFinite(v)?v:null);
    }

    const all=target.concat(actual.filter(v=>v!=null));
    let min=Math.min(...all)-2, max=Math.max(...all)+2;
    if(!Number.isFinite(min)||!Number.isFinite(max)||min===max){ min=target[25]-5; max=target[0]+5; }

    const pad={l:55,r:16,t:16,b:40};
    const x0=pad.l, y0=pad.t, x1=c.width-pad.r, y1=c.height-pad.b;
    const X=i=>x0+(x1-x0)*(i/25);
    const Y=v=>y1-(y1-y0)*((v-min)/(max-min));

    ctx.strokeStyle="rgba(148,163,184,.25)";
    ctx.lineWidth=1;
    for(let i=0;i<=5;i++){
      const yy=y0+(y1-y0)*(i/5);
      ctx.beginPath(); ctx.moveTo(x0,yy); ctx.lineTo(x1,yy); ctx.stroke();
    }

    ctx.fillStyle="rgba(148,163,184,.9)";
    ctx.font="12px "+getComputedStyle(document.body).fontFamily;
    for(let i=0;i<=5;i++){
      const v=min+(max-min)*(i/5);
      ctx.fillText(String(round(v,0)), 10, Y(v)+4);
      const idx=Math.round(25*(i/5));
      const lbl=document.documentElement.classList.contains("lang-ar")?("أ"+(idx+1)):("W"+(idx+1));
      ctx.fillText(lbl, X(idx)-10, c.height-16);
    }

    ctx.strokeStyle="rgba(96,165,250,.95)";
    ctx.lineWidth=2.5;
    ctx.beginPath();
    target.forEach((v,i)=>{ const xx=X(i), yy=Y(v); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); });
    ctx.stroke();

    ctx.strokeStyle="rgba(34,197,94,.95)";
    ctx.fillStyle="rgba(34,197,94,.95)";
    ctx.lineWidth=2;
    let started=false;
    ctx.beginPath();
    actual.forEach((v,i)=>{
      if(v==null) return;
      const xx=X(i), yy=Y(v);
      if(!started){ ctx.moveTo(xx,yy); started=true; } else ctx.lineTo(xx,yy);
    });
    if(started) ctx.stroke();
    actual.forEach((v,i)=>{
      if(v==null) return;
      const xx=X(i), yy=Y(v);
      ctx.beginPath(); ctx.arc(xx,yy,4.2,0,Math.PI*2); ctx.fill();
    });

    $("legend").textContent = T().legend;

    let lastW=0,lastV=null;
    for(let wk=26; wk>=1; wk--){
      const v=state.logs[String(wk)]?.weight;
      if(Number.isFinite(v)){ lastW=wk; lastV=v; break; }
    }
    if(lastW){
      const tar=state.plan.rows[lastW-1].targetW;
      const diff=round(lastV-tar,1);
      $("status").textContent = diff<=0 ? T().ahead(fmt(Math.abs(diff),1), lastW) : T().behind(fmt(diff,1), lastW);
    }else{
      $("status").textContent = document.documentElement.classList.contains("lang-ar")?"أضف قياسًا أسبوعيًا ليظهر التقييم.":"Add a weekly log to see status.";
    }
  }

  function renderAll(){
    renderResults();
    renderPlan();
    renderLogs();
    drawChart();
  }

  /* =========================
     Export
  ========================= */
  function downloadText(name, text){
    const blob=new Blob([text], {type:"text/plain;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
  }
  function toCSV(rows, headers){
    const esc=(v)=>{
      const s=(v==null?"":String(v));
      return (/[,"\n]/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const lines=[];
    lines.push(headers.map(esc).join(","));
    rows.forEach(r=>lines.push(headers.map(h=>esc(r[h])).join(",")));
    return lines.join("\n");
  }

  /* =========================
     Events
  ========================= */
  function calcAndPlan(){
    const inp=readInputs();
    state.plan=generatePlan(inp);
    save();
    renderAll();
  }

  $("btnLang").addEventListener("click", cycleLang);
  $("btnTheme").addEventListener("click", cycleTheme);

  $("btnCalc").addEventListener("click", calcAndPlan);
  $("btnRegen").addEventListener("click", calcAndPlan);

  $("btnSave").addEventListener("click", ()=>{
    readInputs(); save(); alert(T().msgSaved);
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm(T().msgConfirmAll)) return;
    localStorage.removeItem(STORE);
    location.reload();
  });

  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.setAttribute("aria-selected","false"));
      b.setAttribute("aria-selected","true");
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(b.dataset.tab).classList.add("active");
      if(b.dataset.tab==="track") drawChart();
    });
  });

  $("btnAddLog").addEventListener("click", ()=>{
    if(!state.plan){ alert(T().msgNeedPlan); return; }
    const wk=parseInt($("logWeek").value,10);
    const w=parseFloat($("logWeight").value);
    const wa=parseFloat($("logWaist").value);
    const notes=($("logNotes").value||"").trim();

    if(!(wk>=1 && wk<=26)){ alert(T().msgWeekRange); return; }
    if(!Number.isFinite(w)){ alert(T().msgEnterWeight); return; }

    state.logs[String(wk)]={ weight:round(w,1), waist:Number.isFinite(wa)?round(wa,1):null, notes };
    save();
    renderLogs(); drawChart();
    alert(T().msgUpdated);
  });

  $("btnNext").addEventListener("click", ()=>{
    const wk=parseInt($("logWeek").value,10);
    $("logWeek").value=String(clamp(wk+1,1,26));
    $("logWeight").value=""; $("logWaist").value=""; $("logNotes").value="";
  });

  $("btnClearLogs").addEventListener("click", ()=>{
    if(!confirm(T().msgConfirmLogs)) return;
    state.logs={}; save();
    renderLogs(); drawChart();
  });

  $("btnPrint").addEventListener("click", ()=>window.print());

  $("btnExportPlan").addEventListener("click", ()=>{
    if(!state.plan){ alert(T().msgNeedPlan); return; }
    const headers=["week","targetW","calories","protein","days","mins","steps","note"];
    const rows=state.plan.rows.map(r=>({ ...r }));
    downloadText(document.documentElement.classList.contains("lang-ar")?"plan_walkonly_6m.csv":"plan_walkonly_6m_en.csv", toCSV(rows, headers));
  });

  $("btnExportLogs").addEventListener("click", ()=>{
    if(!state.plan){ alert(T().msgNeedPlan); return; }
    const rows=[];
    for(let wk=1; wk<=26; wk++){
      const log=state.logs[String(wk)]||{};
      rows.push({
        week:wk,
        actualWeight:log.weight??"",
        targetWeight:state.plan.rows[wk-1]?.targetW??"",
        waist:log.waist??"",
        notes:log.notes??""
      });
    }
    downloadText(document.documentElement.classList.contains("lang-ar")?"logs_walkonly.csv":"logs_walkonly_en.csv", toCSV(rows, ["week","actualWeight","targetWeight","waist","notes"]));
  });

  /* =========================
     Init
  ========================= */
  load();
  applyLang();
  applyTheme();
  bindInputs();
  if(state.plan){ /* keep plan */ } else { state.plan=null; }
  renderAll();
</script>
</body>
</html>
